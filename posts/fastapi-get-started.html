<!DOCTYPE html>
<html style="scroll-behavior: smooth;">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>Bloggy</title>
  <meta property="og:type" content="">
  <meta name="description" content="This is a blog that is hopefully one day be fully generated by static site generator that im working on.">
  <meta name="twitter:title" content="blog made with ssg written in python">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="assets/img/0256.jpg">
  <meta name="twitter:description" content="">
  <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alfa+Slab+One">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alice">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Alike">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="assets/fonts/fontawesome5-overrides.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/aos/2.1.1/aos.css">
  <link rel="stylesheet" href="assets/css/style.css">

</head>

<body>
  <nav class="navbar navbar-light navbar-expand-lg fixed-top" data-aos="fade-down" data-aos-duration="50" data-aos-delay="200" id="mainNav">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">BLOGGY</a>
    <button data-toggle="collapse" data-target="#navbarResponsive" class="navbar-toggler" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      <i class="fa fa-bars"></i>
    </button>

    <div class="collapse navbar-collapse" id="navbarResponsive">

      <ul class="nav navbar-nav ml-auto">
	<li class="nav-item" role="presentation">
          <a class="nav-link" href="/">Home</a>
        </li>
        
        <li class="nav-item" role="presentation">
          <a class="nav-link" href="/about.html">About</a>
        </li>
        
        <li class="nav-item" role="presentation">
          <a class="nav-link" href="/contact.html">Contact</a>
        </li>
        <!-- New Post
             Hidden because its supposed to work only with backend in localhost
        <li class="nav-item" role="presentation">
          <a class="nav-link" href="/newpost.html">New Post</a>
        </li>
        -->

      </ul>
    </div>
  </div>
</nav>
  

<header class="masthead" style="background-image: url(&quot;assets/img/bg.jpg&quot;);width: 100%;height: 100vh;">
   
<div class="overlay"><a href="http://github.com/fer"></a></div>
<div class="container">
  <div class="row">
    <div class="col-md-10 col-lg-8 mx-auto">
      <div class="post-heading">
        <h1>Get started with FastAPI</h1>
        <h2 class="subheading">by building polls</h2>
	<span class="meta" style="font-family: Alike, serif;filter: brightness(124%) contrast(200%);font-size: 19px;">
	  Posted by&nbsp;
	  <a href="about.html">Andrija Jovanovic</a>
	  &nbsp;on 2020-05-13
	</span>
      </div>
    </div>
    
  </div>
</div>
</header>
<article>
  <div class="container">
    <div class="row">
      <div class="col-md-10 col-lg-8 mx-auto">
	<p>With this blog post you'll learn how to build polls with <a href="https://fastapi.tiangolo.com">FastAPI</a></p>

<p><strong>FastAPI, What is it?</strong></p>

<p>FastAPI is a web framework for building APIs. As per its official page</p>

<blockquote>
  <p>FastAPI is a modern, fast (high-performance), web framework for building APIs with Python 3.6+ based on standard Python type hints.</p>
</blockquote>

<p>It's extremely easy to learn and it is said to have speed on par with <code>Node.js</code>.</p>

<p><strong>Installation</strong></p>

<p>To get started with FastAPI you should have two things installed:</p>

<ul>
<li>FastAPI.</li>
<li>Uvicorn: the ASGI server required for FastAPI.</li>
</ul>

<p>install them with:</p>

<ul>
<li><code>pip install fastapi</code></li>
<li><code>sudo pacman -S uvicorn</code> or alternative for your distro.</li>
</ul>

<p><strong>Basic Example</strong></p>

<pre><code>from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def index():
    return {"message": "Welcome to the world of FastAPI!"}

@app.get("/items/{item}")
def read_item(item: str, q: str = None):
    return {"item": item, "q": q}
</code></pre>

<p>run it with:</p>

<p><code>uvicorn filename:app --reload</code></p>

<p>where <strong>filename</strong> is file with code and <strong>app</strong> is FastAPI instance.  </p>

<p>open browser and go to the:  </p>

<pre><code>http://127.0.0.1:8000/
</code></pre>

<p>you should see the response:  </p>

<pre><code>{"message": "Welcome to the world of FastAPI!"}
</code></pre>

<p>visit:</p>

<pre><code>http://127.0.0.1:8000/items/apple?q=delicious
</code></pre>

<p>you should see the below response:</p>

<pre><code>{"item": "apple", "q": "delicious"}
</code></pre>

<p>that’s great, we have already created an API having two endpoints:</p>

<ul>
<li><p><code>http://127.0.0.1:8000/</code> doesn’t take any parameters and it simply returns a JSON response.</p></li>
<li><p><code>http://127.0.0.1:8000/items/{item}</code> takes a parameter item of type str and optional str query parameter q.</p></li>
</ul>

<p>another good feature of FastAPI is that it provides an interactive API documentation, simply visit:</p>

<ul>
<li><p><code>http://127.0.0.1:8000/docs</code></p></li>
<li><p><code>http://127.0.0.1:8000/redoc</code>.</p></li>
</ul>

<p>Now let’s build our polls API. The endpoints that are created above are static, so they don’t interact with the database. In the next section we will use <a href="https://www.sqlalchemy.org/">SQLAlchemy</a> for ORM and <a href="https://pydantic-docs.helpmanual.io/">Pydantic</a> to create models/schemas to make our APIs dynamic.</p>

<p>This post assumes that you’re familiar with <code>SQLAlchemy</code> and that you are using Linux, you can refer this <a href="https://www.sqlalchemy.org/">docs</a> for more details.</p>

<p><strong>Well make following endpoints</strong>:</p>

<ul>
<li><p>create poll question</p></li>
<li><p>list all poll questions</p></li>
<li><p>get question detail</p></li>
<li><p>edit poll question</p></li>
<li><p>delete poll question</p></li>
<li><p>create choice for a particular poll question</p></li>
<li><p>update votes for a particular question</p></li>
</ul>

<p><strong>Project structure</strong></p>

<p>The project structure will be following:</p>

<pre><code>┏&gt;pollsapi
┣━━━━━&gt;crud.py
┣━━━━━&gt;database.py
┣━━━━━&gt;main.py
┣━━━━━&gt;models.py
┣━━━━━&gt;schemas.py
</code></pre>

<p><strong>database</strong></p>

<p><em>database.py</em></p>

<pre><code>from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker


SQLALCHEMY_DATABASE_URL = "postgresql://YOUR_USERNAME:YOUR_PASSWORD@localhost:5432/DATABASE_NAME"

engine = create_engine(
SQLALCHEMY_DATABASE_URL
)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()
</code></pre>

<p><em>models.py</em></p>

<pre><code>from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, String, Integer, DateTime, ForeignKey
from sqlalchemy.orm import relationship

from database import Base


class Question(Base):
    __tablename__ = "question"
    id = Column(Integer, primary_key=True)
    question_text = Column(String(200))
    pub_date = Column(DateTime)

    choices = relationship('Choice', back_populates="question")


class Choice(Base):
    __tablename__ = "choice"
    id = Column(Integer, primary_key=True)
    question_id = Column(Integer, ForeignKey('question.id', ondelete='CASCADE'))
    choice_text = Column(String(200))
    votes = Column(Integer, default=0)

    question = relationship("Question", back_populates="choices")
</code></pre>

<p>bt doing this we have created <code>relationship</code> provided by <code>SQLAlchemy ORM</code>. By using it we can simply access <code>question.choices</code> to get all choices for that particular question.</p>

<p>Simmilarly we can use <code>choice.question</code> to get question object that is related to that choice.</p>

<p><strong>Schemas</strong></p>

<p><em>schemas.py</em></p>

<pre><code>from datetime import datetime

from pydantic import BaseModel
from typing import List


# Choice schema

class ChoiceBase(BaseModel):
    choice_text: str
    votes: int = 0

class ChoiceCreate(ChoiceBase):
    pass

class ChoiceList(ChoiceBase):
    id: int

    class Config:
        orm_mode = True


# Question schema

class QuestionBase(BaseModel):
    question_text: str
    pub_date: datetime

class QuestionCreate(QuestionBase):
    pass

class Question(QuestionBase):
    id: int

    class Config:
        orm_mode = True

class QuestionInfo(Question):
    choices: List[ChoiceList] = []
</code></pre>

<p>Attributes in SQLAlchemy is different than in pydantic. in sqlalchemy they are defined with <code>=</code> and type is passed in <code>Column</code> like in:</p>

<pre><code>question_text = Column(String)
</code></pre>

<p>while pydantic uses <code>:</code></p>

<pre><code>question_text:str
</code></pre>

<p>Pyndatic models/schemas will be mapped to the incoming data (data in POST, PUT requests) and to the response data returned from the API itself.</p>

<p>We have created base classes <code>QuestionBase</code> and <code>ChoiceBase</code> that extends pydantic BaseModel to hold attributes which are common for creating or reading data and created other classes that inherit from these base classes, the reason being we want specific attributes for creation and reading.</p>

<p>like for example - for creating a choice we need <code>choice_text</code> and votes (if not passed, it defaults to 0) so we will use <code>ChoiceCreate</code> and for reading the choice, we want to return id, <code>choice_text</code> and votes and in this case we will use <code>ChoiceList</code>.</p>

<p>Another important thing to understand is the use of <code>orm_mode = True</code>, notice we have added a <code>class Config</code> and have set orm<em>mode = True, this is because by default Pydantic model could read the data from dict and it can’t read the data if the data is an ORM model so with the orm</em>mode = True added to our class, Pydantic model can also read the data from the object something like <code>data.question_text</code>.</p>

<p>Ok, we will now create <code>pollsapi/crud.py</code> which will contain all the functions to perform <code>CRUD</code> (<code>C</code>reate, 
<code>R</code>etrieve, 
<code>U</code>pdate 
and <code>D</code>elete) operations.</p>

<p><em>crud.py</em></p>

<pre><code>from sqlalchemy.orm import Session

from models import Base, Question, Choice
import schema

# Question

def create_question(db: Session, question: schema.QuestionCreate):
    obj = Question(**question.dict())
    db.add(obj)
    db.commit()
    return obj

def get_all_questions(db: Session):
    return db.query(Question).all()

def get_question(db:Session, qid):
    return db.query(Question).filter(Question.id == qid).first()

def edit_question(db: Session, qid, question: schema.QuestionCreate):
    obj = db.query(Question).filter(Question.id == qid).first()
    obj.question_text = question.question_text
    obj.pub_date = question.pub_date
    db.commit()
    return obj

def delete_question(db: Session, qid):
    db.query(Question).filter(Question.id == qid).delete()
    db.commit()

# Choice

def create_choice(db:Session, qid: int, choice: schema.ChoiceCreate):
    obj = Choice(**choice.dict(), question_id=qid)
    db.add(obj)
    db.commit()
    return obj

def update_vote(choice_id: int, db:Session):
    obj = db.query(Choice).filter(Choice.id == choice_id).first()
    obj.votes += 1
    db.commit()
    return obj
</code></pre>

<p>with this file we have created all the utility functions which will be used in the API .</p>

<p>Now we'll make <code>pollsapi/main.py</code>, which will make use of all the files we created above.</p>

<p><strong>Create a poll question</strong></p>

<p><em>main.py</em></p>

<pre><code>from fastapi import FastAPI, HTTPException, Response, Depends
import schema
from typing import List

from sqlalchemy.orm import Session

import crud
from database import SessionLocal, engine
from models import Base

Base.metadata.create_all(bind=engine)

app = FastAPI()

# Dependency
def get_db():
    try:
        db = SessionLocal()
        yield db
    finally:
        db.close()


## Question

@app.post("/questions/", response_model=schema.QuestionInfo)
def create_question(question: schema.QuestionCreate, db: Session = Depends(get_db)):
    return crud.create_question(db=db, question=question)
</code></pre>

<ul>
<li><p>line <code>Base.metadata.create_all(bind=engine)</code> creates database tables utilizing SQLAlchemy models defined above in <code>models.py</code></p></li>
<li><p>function <code>create_question</code> is decorated using the <code>app</code> object created above which is an instance of <code>FastAPI</code>, it takes two arguments <code>path</code> and <code>response_model</code>. response_model returns the schema <code>QuestionInfo</code> so the endpoint will return the fields <code>id</code>, <code>question_text</code> and <code>pub_date</code>.</p></li>
<li><p>We have created a function <code>create_question</code>, first argument receives the request data and maps it to the schema <code>QuestionCreate</code> which has the fields <code>question_text</code> and <code>pub_date</code> and the second argument creates a session/request and then it gets closed after the request is completed.</p></li>
</ul>

<p>now visit:</p>

<pre><code>http:127.0.0.1/docs
</code></pre>

<p>you should see something section to POST /questions/ something like this:</p>

<p><img src="assets/img/fastapidocs.png" alt="img" /></p>

<p>click on that section and it will expand, now click on <code>Try it out</code> to test your shiny new API.</p>

<p><strong><em>to be continued</em></strong></p>

      </div>
    </div>
  </div>
</article>

  <div class="clearfix"></div>
  <div class="clearfix"></div>
</div>
</div>
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-10 col-lg-8 mx-auto">
        <ul class="list-inline text-center">
          <li class="list-inline-item" data-bs-hover-animate="jello">
            <a href="https://github.com/andrijaJ01" target="_blank">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fab fa-github fa-stack-1x fa-inverse" data-toggle="tooltip" data-bs-tooltip="" title="github"></i>
              </span>
            </a>
          </li>
          <li class="list-inline-item" data-bs-hover-animate="jello">
            <a href="https://twitter.com/andrijaj01" target="_blank">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fab fa-twitter fa-stack-1x fa-inverse" data-toggle="tooltip" data-bs-tooltip="" title="twitter"></i>
              </span>
            </a>
          </li>
          <li class="list-inline-item" data-bs-hover-animate="jello">
            <a href="https://gitlab.com/andrijajovanovic001" target="_blank">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fab fa-gitlab fa-stack-1x fa-inverse" data-toggle="tooltip" data-bs-tooltip="" title="gitlab"></i>
              </span>
            </a>
          </li>
          <li class="list-inline-item" data-bs-hover-animate="jello">
            <a href="https://andrijajovanovic.ga" target="_blank">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fab fa-instagram fa-stack-1x fa-inverse" data-toggle="tooltip" data-bs-tooltip="" title="instagram"></i>
              </span>
            </a>
          </li>
        </ul>
        <p class="text-muted copyright">Copyright&nbsp;©&nbsp;Andrija Jovanovic 2021</p>
      </div>
    </div>
  </div>
</footer>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/bs-init.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.1.1/aos.js"></script>
<script src="assets/js/clean-blog.js"></script>
</body>

</html>